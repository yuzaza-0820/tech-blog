---
title: "ド初心者がメール送信機能実装した話" #ここにブログのタイトルを記載
emoji: "🔰" #記事に絵文字を付けられる。任意でOK
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Laravel] #記事につけるタグ。PHP、Laravelなどのキーワードを入れる。任意でOK
published: true #公開非公開の設定。レビュー後にtrueに変える
publication_name: "sdb_blog"
---
はじめまして。文系未経験でエンジニアを始めた者です。
今回は、そんなド初心者がLaravelでメール処理機能を実装した話を記事にしてみました！
これから未経験でエンジニアになりたいという人の希望になればと思います。

# 実装の流れ
今回、環境構築は割愛します。ちなみにDockerを使用しました。

# 1 artisanコマンドでMailableクラスを作成
ここでは実際に送る「メールの内容（件名や本文）」を定義しています。
そしてBladeテンプレート（emails.reminder.blade.php）を使ってHTMLメールを組み立てます。
このBladeテンプレートは元からあるものではないので作りましょう。
コンテナの中に入り

```bash
php artisan make:mail ReminderMail
```

app/Mail/ReminderMail.phpが作成されます。

```php:ReminderMail
class ReminderMail extends Mailable
{
    public $reminder;

    public function __construct($reminder)
    {
        $this->reminder = $reminder;
    }

    public function build()
    {
        return $this->subject('リマインダー通知')
                    ->view('emails.reminder');
    }
}
```

# 2 Jobで送信処理を分ける
これはメール送信を「バックグラウンド処理（キュー）」として実行する機能です。
これによりメールを大量のユーザーに送る場合、送信に時間がかかってもWebアプリが止まらずに済みます。
この Job では、「どのリマインダーのメールを送るのか」を
Reminder オブジェクトとして受け取ります。

```bash
php artisan make:job SendUserMailJob
```

app/Jobs/SendUserMailJob.phpが生成されます。

```php:SendUserMailJob
class SendUserMailJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    public $reminder;

    public function __construct(Reminder $reminder)
  {
        $this->reminder = $reminder;
    }

    public function handle()
    {
        Mail::to($this->reminder->user->email)->send(new ReminderMail($this->reminder));
    }
}
```

Jobは、`php artisan queue:work`を実行が必要です。
# 3 送信判定を行うConsoleコマンドを作成
現在の時刻と一致する send_time を持つリマインダーを探し、対象のリマインダーに対して、ジョブを dispatch（実行予約）する機能です。

```bash
php artisan make:command SendReminderEmail
```

app/Console/Commands/SendReminderEmail.phpが生成されます。

```php:SendReminderEmail
protected $signature = 'email:reminder';

public function handle()
{
    $now = now()->format('H:i:00'); // 現在時刻を「08:00:00」形式で取得

    Reminder::where('is_active', true)
        ->where('send_time', $now)
        ->each(function ($reminder) {
            SendUserMailJob::dispatch($reminder);
        });
}
```

# 4 スケジューラーで毎分実行
Laravelの「タスクスケジューラ」で、さきほどのコマンド（email:reminder）を毎分自動実行するように登録するファイルです。
毎分に設定するのは、ユーザーによってメールを送信する時間がそれぞれ異なるためです。

`app/Console/Kernel.php`に次を追加します：

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('email:reminder')->everyMinute();
}
```

# 5 テストについて
先ほど登録したコマンドphp artisan email:reminderで送信処理テストができます。
Mailpitなどのツールを用いて送信できたメールをUIに表示させることも可能です。

---
ここまで読んでいただきありがとうございました！
少しでも参考になれば幸いです。